---
title:  "라즈베리파이(16) WEB WAS 세션클러스터링"
excerpt: "라즈베리파이(16) WEB WAS 세션클러스터링 입니다."
categories:
  - web-service-dev
tags:
  - [web, dev]
toc: true
toc_sticky: true

last_modified_at: 2022-10-12T20:00:00-05:00
---

# 라즈베리파이 WEB WAS 세션클러스터링
## 세션클러스터링 개요
  : 라즈베리파이에 로드밸런싱이 적용된ㅇ Apache & Tomcat서버에 세션클러스터링을 적용한다.

  - 적용전 로드밸런싱 상태
    : mod_jk의 load balancing 방식은 기본적으로 round robin이지만 한번 왔던 요청은 같은 Engine에 보내준다. 만약 Session 객체를 사용하지 않은 경우는 (예를 들면 html 단순 실행) 번갈아가며 WAS1,2 의 문서를 출력하는것으로 확인했다.
  
  - 문제점
    : Session객체를 사용한순간 mod_jk 가 한번왔던 요청을 같은 Engine 으로 보내서 처리한다고 앞서 설명했다. 만약 한쪽 WAS를 바라보던 상황에서에서 `fail` 발생하면 다른 WAS를 바라보게 되는데 이때 유지하던 세션은 잃어버리는 문제점이 있다.

  - 궁금한점
    : stiky 라는 개념이 있는것 같다. 한번이라도 요청이 있어서 쿠키에 세션ID값이 저장되어 한쪽 WAS만 바라본다?


  - 세션클러스터링 적용 후
    : 한쪽 WAS가 끊어져도 동일한 



  stiki
  첫 request에 대한 응답을 준 서버에만 세션이 관리됩니다.

하지만 세션을 공유하지는 못한다. 한쪽 서버가 
  - 로드밸런싱된 WAS서버 한대가 고장나면 세션을 잃어버리지않고 동일한 세션을 갖도록 세션관리 하는 것이다.
  - Serssion 객체가 저장된 순간 
  - 물리적으로 서버를 분리하여 부하를 줄인다.
  




  - 1번 서버에서 login session이 저장되었다면, 2번 서버와 3번 서버에도 서버1에 저장되어있는 세션을 전파(복사)하는 것이라고 할 수 있습니다.. 따라서 1번 방법의 문제점인 특정 서버에만 트래픽이 몰리는 문제를 해결할 수 있게 됩니다.



  L4 스위치의 경우 사용자는 접속했던 WAS로 접속을 유도해주지만 하나의 WAS에서 허용된 동접수를 초과한 접속이 발생할 경우 다른쪽으로의 접속을 유도해주게 됩니다.
  {: .notice--info}

## 세션클러스터링 구축
### WEB서버 mod_jk 설정
  : 웹서버(아파치) 측의 설정.

  1. (아파치루트/톰캣커넥터루트/workers.properties) 설정  
    : 워커를 정의 및 로드 밸런싱을 위한 다중화 톰캣 설정을 한다.

      ```bash
      # ASIS
      # worker.list=lilo_lb                     # 리스트정의
      # worker.lilo_lb.type=lb                  # 타입정의
      # worker.lilo_lb.balance_workers=worker1  # load balancing할 worker 속성 지정, (worker1)를 lilo_lb 라는 리스트 하위에 추가한다.
      # worker.worker1.port=8009                # mod_jk 가 이용하는 APJ 연동 포트
      # worker.worker1.host=192.168.0.10        # 연동시킬 나의 다른 라즈베리파이 WAS서버 주소를 입력
      # worker.wokrer1.type=ajp13               # 연동모듈 프로토콜


      # TOBE
      worker.list=blang_balancer
      worker.blang_balancer.type=lb
      worker.blang_balancer.balance_workers=tomcat1,tomcat2

      # Server1
      worker.tomcat1.port=18009          # 로드밸런싱 전용포트 포트중첩불가 톰캣에서 설정한 포트와 일치해야함
      worker.tomcat1.host=192.168.0.10
      worker.tomcat1.type=ajp13
      worker.tomcat1.lbfactor=1          # 서버밸런스비율

      # Server2
      worker.tomcat2.port=28009
      worker.tomcat2.host=192.168.0.12
      worker.tomcat2.type=ajp13
      worker.tomcat2.lbfactor=1

      ```
      
      ajp13 을 apj13 으로 작성해서 한참을 찾았다.... ㅋㅋㅋㅋ...
      {: .notice--info}
      
  2. (아파치루트/conf/httpd.conf) 설정  
    : 톰캣에 통과시킬 매핑을 정의하는 jk마운트를 최종 설정한다.

      ```bash
      # 최종으로 mod_jk JK마운트로 worker를 등록한다. url를 구분하여 톰캣이 처리할지 결정한다.
      # /* 으로들어오는 요청을 blang_balancer 라는 워커로 넘긴다.
      # 워커 설정에는 로드밸런싱이 설정되어있다.
      # tomcat1, tomcat2 골고루 요청을 분산해줄 것이다.

      # ASIS
      #jkMount /* lilo_lb

      # TOBE
      jkMount /* blang_balancer

      ```

     
### WAS서버 mod_jk 설정
  : 와스서버(톰캣) 측의 설정.

  1. (톰캣루트/conf/server.xml) 설정  
    : WAS 2대의 톰캣의 mod_jk 커넥터 포트를 겹치지 않도록 설정한다. 

***WAS1***

      ```bash
      #(WAS 1번)
      cd /fswas/tomcat/apache-tomcat-8.5.82/conf
      vi server.xml
      
      
      # 아래 mod_jk 로드밸런싱 전용 포트를 서버별로 각각 다르게 설정한다.
      <!-- Define an AJP 1.3 Connector on port 8009 -->
      <Connector protocol="AJP/1.3"
               address="0.0.0.0"
               secretRequired="false"
               # port="8009"     # 이전에 설정한 mod_jk 연동 포트이다. 주석처리하고
               port="18009"      # (#WAS1) 이부분은 로드밸런싱 내용이다. 이렇게 추가한다. (달라야한다)
               redirectPort="8443" />

      (중략)
      
      <!-- ASIS -->
      <!--
      <Engine name="Catalina" defaultHost="localhost">
      -->
  
      <!-- TOBE (로드밸런싱 사용시 jvmRoute 옵션으로 워커명을 준다.)-->
      <Engine name="Catalina" defaultHost="localhost" jvmRoute="tomcat1">
      
      ```

***WAS2***

      ```bash
      #(WAS 2번)
      cd /fswas/tomcat/apache-tomcat-8.5.82/conf
      vi server.xml
      
      
      # 아래 mod_jk 로드밸런싱 전용 포트를 서버별로 각각 다르게 설정한다.
      <!-- Define an AJP 1.3 Connector on port 8009 -->
      <Connector protocol="AJP/1.3"
               address="0.0.0.0"
               secretRequired="false"
               # port="8009"     # 이전에 설정한 mod_jk 연동 포트이다. 주석처리하고
               port="28009"      # (#WAS2) 이부분은 로드밸런싱 내용이다. 이렇게 추가한다. (달라야한다)
               redirectPort="8443" />

      (중략)
      
      <!-- ASIS -->
      <!--
      <Engine name="Catalina" defaultHost="localhost">
      -->
  
      <!-- TOBE (로드밸런싱 사용시 jvmRoute 옵션으로 워커명을 준다.)-->
      <Engine name="Catalina" defaultHost="localhost" jvmRoute="tomcat2">
      
      ```
      
### 연동완료 정리
  : 부하분산을 위한 mod_jk 의 로드밸런싱이 완료되었다. was1번,2번에 동일한 url서블릿 매핑을 가진 jsp주소를 호출해보면 (내용은 달라야한다) 서로 다른내용이 번갈아가며 출력되는것을 볼 수 있다.
  
![사진2](/assets/images/ToyDev/WebServiceDev/mod_jk_success_loadbalancer.png)

> ***참고) 세션 클러스터링이 필요하다.***  
> 아파치1, 톰캣2 구성의 로드밸런싱을 완성했다.
> 접속하면 WAS서버가 번갈아가면서 처리되는걸 보면 목적대로 로드밸런싱은 성공했다.
> 하지만 로그인 같은 경우 세션이 유지되어야하는데 이렇게 번갈아가면서 처리되면 안된다.
> 세션이 공유되어야하는 경우 세션 클러스터링 작업이 별도로 필요하다.
> 세션 클러스터링은 한쪽이 끊어져도 두개의 톰캣이 하나의 세션을 유지할 수 있도록 서로 공유한다.


