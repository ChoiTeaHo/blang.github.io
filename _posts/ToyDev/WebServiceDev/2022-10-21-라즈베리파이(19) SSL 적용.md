---
title:  "라즈베리파이(19) SSL 적용"
excerpt: "라즈베리파이(19) SSL 적용 입니다."
categories:
  - web-service-dev
tags:
  - [web, dev]
toc: true
toc_sticky: true

last_modified_at: 2022-10-12T20:00:00-05:00
---

# 라즈베리파이 SSL 적용
## SSL 적용 개요
  : 이전 포스팅에서 발급받은 cerbot(Let’s Encrypt) 인증서를 적용해보자.

## SSL 으로 어떻게 접근할까?
  : SSL 은 https 이다. 그런데 보통 우리는 http, https 등의 프로토콜을 생략하고 도메인만 입력하면 https 로 접속된다. 우리한테는 당연한거지만 사실 따로 설정을 해주어야 한다. 

## SSL 접근방법
  : SSL 접근방법은 다양하다.

### 방법1. 웹페이지에서 처리
  : 사용자가 주소를 입력하면 html, jsp 로 이동되고 내용에서 `https + 주소` 하드코딩으로 redirect 처리한다.

**Example)**
- location.href 
- jquery, javascript


***비권장)***  
이런 방법은 다수의 페이지를 수정해야 할 때 너무 손이 많이가고, 보안적으로 취약하다.(페이지가 로딩하는 내용을 확인하는 등)
{: .notice--info}


### 방법2. mod_alias
  : 아파치에서 제공하는 모듈이다.

**Example)**

```bash
# 1. mod_alias의 redirect기능

NameVirtualHost *:80
<VirtualHost *:80>
   ServerName www.example.com
   Redirect permanent / https://secure.example.com(https:443포트의 servername 해당서버의 도메인)/
</VirtualHost>

```

***특정URL 용도로 권장)***  
단순히 원하는 특정url을 정해진 어떤 url로 이동한다 라고 했을 때 유용하다.
어떤 경로를 강제로 사용하지 못하게하거나, 위와 같은 경우를 간단히 처리할 때 유용하다.
실질적으로 추가할 라인도 단한 줄에 불과하다.
{: .notice--info}


### 방법3. mod_rewrite
  : 아파치에서 제공하는 모듈이다.

**Example)**

```bash
# 1. mod_alias의 redirect기능
RewriteEngine On
RewriteCond %{HTTPS} !=on
RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]

```


***복잡한 URL 처리 용도로 권장)***  
rewrite를 사용할 경우 좀 더 많은 수정과 정규식을 사용해야 한다. 이 경우에는 첫번째 방식(Redirect)을 추천한다고 한다. 이유는 단지 포트를 옮기기 위한 작업이므로 복잡한 상황에 대한 대처는 필요하지 않기 때문이다.
{: .notice--info}



## SSL 적용 (Apache 2.4 기준)
### WEB서버 SSL 설정
  : 웹서버(아파치) 측에서 수정한다.

  1. (아파치루트/conf/httpd.conf) 모듈로드 시키기  
    : ssl 모듈을 로드하기 위해 주석해제 한다.

      ```bash
      cd /fswas/apache/httpd/httpd-2.4.541/conf/
      vi httpd.conf

      (중략..)
      # SSL 모듈 사용하기위해 주석해제
      LoadModule ssl_module modules/mod_ssl.so

      ```

  2. (아파치루트/conf/httpd.conf) SSL설정파일 삽입하기  
    : ssl 설정파일을 include 하기위해 주석해제 한다.

      ```bash
      cd /fswas/apache/httpd/httpd-2.4.541/conf/
      vi httpd.con

      (중략..)
      # (주석해제)SSL 모듈 사용하기위해 해제한다.
      LoadModule ssl_module modules/mod_ssl.so

      ```
 
  3. (아파치루트/conf/extra/httpd-ssl.conf) SSL설정파일 수정하기  
    : 주석해제한 설정 파일 내용을 수정한다.  

      ```bash
      vi conf/extra/httpd-ssl.conf



      ##############################################
      - ASIS

      ##############################################
      #  <VirtualHost _default_:443>
      
      #      DocumentRoot "/fswas/apache/httpd/httpd-2.4.541/htdocs"
      #      ServerName www.example.com:443
      #      ServerAdmin you@example.com
      #      ErrorLog "/fswas/apache/httpd/httpd-2.4.541/logs/error_log"
      #      TransferLog "/fswas/apache/httpd/httpd-2.4.541/logs/access_log"

      #      #   SSL Engine Switch:
      #      SSLEngine on

      #      #   Server Certificate:

      #      SSLProtocol all -SSLv3
      #      SSLProxyProtocol all -SSLv3
      #      SSLCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
      #      SSLProxyCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES

      #      SSLCertificateFile "/fswas/apache/httpd/httpd-2.4.541/conf/server.crt"
      #      SSLCertificateKeyFile "/fswas/apache/httpd/httpd-2.4.541/conf/server.key"
      #      # SSLCACertificateFile "/fswas/apache/httpd/httpd-2.4.541/conf/server-ca.crt"

      #  </VirtualHost>


      ##############################################
      - TOBE (아래와 같이 변경)
      ##############################################
      <VirtualHost _default_:443>
      
          # 기본정보 수정하기
          DocumentRoot "/fswas/apache/httpd/httpd-2.4.541/htdocs"
          ServerName www.blang.co.kr:443  # 변경
          ServerAdmin layup3@naver.com    # 변경
          ErrorLog "/fswas/apache/httpd/httpd-2.4.541/logs/error_log"
          TransferLog "/fswas/apache/httpd/httpd-2.4.541/logs/access_log"

          #   SSL Engine Switch:
          SSLEngine on

          #   Server Certificate:
          (중략...)

          SSLProtocol all -SSLv3
          SSLProxyProtocol all -SSLv3
          SSLCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
          SSLProxyCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
 
          # SSL(Let’s Encrypt) 발급한 경로 지정하기
          SSLCertificateFile "/etc/letsencrypt/live/www.blang.co.kr/cert.pem"        #발급한 경로로 설정
          SSLCertificateKeyFile "/etc/letsencrypt/live/www.blang.co.kr/privkey.pem"  #발급한 경로로 설정
          SSLCACertificateFile "/etc/letsencrypt/live/www.blang.co.kr/chain.pem"  #발급한 경로로 설정

      </VirtualHost>

      ```
     
  4. 설정완료  


## 테스트
  : WEB서버를 시작하고 https 으로 접속해본다.  

### 문제발생(1) :: shmcb 에러현상
  : SSL 설정을 완료했지만 다음과 같은 에러가 발생한다.

```bash
# 웹서버 기동 쉘
webstart   

# 에러가 발생했다.
AH00526: Syntax error on line 92 of /fswas/apache/httpd/httpd-2.4.541/conf/extra/httpd-ssl.conf:
SSLSessionCache: 'shmcb' session cache not supported (known names: ). Maybe you need to load the appropriate socache module (mod_socache_shmcb?).

```

1. 원인(1)
  : 다음과같이 세션캐쉬가 지원하지않는다며 shmcb 모듈이라는게 필요하다고 에러가난다. APACHE 2.4에 SSL을 적용 후 재구동하였을때 이슈인가 보다
	
2. 해결방안(1)
  : (아파치루트/conf/httpd.conf) 아래처럼 주석을 해제하고 모듈을 로드한다.

    ```bash
    # 우선 모듈이 있는지 확인
    cd /fswas/apache/httpd/httpd-2.4.541/modules 

    ls | grep shmcb
    mod_socache_shmcb.so  # 모듈이 존재함을 확인했다.

    ```

    ```bash     
    # mod_socache_shmcb.so 모듈 로드하기
    cd /fswas/apache/httpd/httpd-2.4.541/conf/
    vi httpd.conf
    
    # CTH SSL 사용시 세션캐쉬관련하여 해당모듈이 필요함
    # 그러므 주석해제
    LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
    
    ```

3. 해결완료(1)  
  : 접속하여 다시 확인한다. (https://www.blang.co.kr/)

  > https 프로토콜이 적용되어 404 에러가 아닌 정상적으로 접속이 된다.
  > 하지만 mod_jk 으로 로드밸런싱 설정된 WAS서버로 넘어가지 않았다.

___

### 문제발생(2) :: https 로드밸런싱 불가현상
  : 위 문제해결로 SSL 적용이 완료되어 https 접속이 가능했지만 WAS서버측으로 로드밸런싱이 작동하지 않는 문제가 발생했다.  

![사진1](/assets/images/ToyDev/WebServiceDev/ssl_fail1.jpg)
  
위 페이지는 웹서버 내의 존재하는 index.html 파일이다.  
1 WAS측의 '/' 루트로 매핑되어 서블릿이 실행되어야하는데   
2 WEB측의 '/' 루트로 매핑되어 웹서버 web.xml안에서 <welcome-file> 태그로 정의된 웹서버의 index.html 이 호출되었다.  
3 결국 지금상황은 https 접속이 되었지만 https 프로토콜로 접속한 경우는 로드밸런싱이 안된다는 뜻이 된다.  
{: .notice--info}

1. 원인(2)
  : JkMount(mod_jk.so)를 이용해서 Tomcat과 연동되는 경우, 80포트의 JkMount 설정을 SSL 관련 VirtualHost에 동일하게 복사해야 한다고 한다. 즉, 기존에 80포트에 설정(httpd.conf)해둔 jkMount 내용을 ssl설정파일(httpd-ssl.conf) 안에 동일하게 작성해주어야 한다. 즉, SSL(443) 포트에도 jkMount 처리를 해주어야 한다는것이다.

2. 해결방안(2)
  : (아파치루트/conf/extra/httpd-ssl.conf) 안에 80 포트에만 설정해두었던 `JkMount` 를 그대로 복사해서 붙여넣는다.  

    ```bash     
    # httpd.conf 안에서 설정한 JkMount 내용을 복사한뒤 아래 파일 OPEN
    vi 아파치루트/conf/extra/httpd-ssl.conf    
    
    
    # SSL 로드밸런싱처리(이부분 있어야 WAS측 https접속가능)
    JkMount /* blang_balancer
    
    ```

3. 해결완료(2)  
  : 접속하여 다시 확인한다. (https://www.blang.co.kr/)

  > 위 처럼 작성함으로써 ssl(443)포트에도 JkMount 처리하여 톰캣서버로 가도록하니까 
  > 정상적으로 로드밸런싱이 되었다.

___

### 문제발생(3) :: www유무에 따른 ssl적용
  : 지금까지 내용으로면 문제없이 SSL 반영이 정상완료로 보인다. 하지만, 문제가 있었다. `문제(2)` 에서 사진을 자세히보면 ssl이 적용되지 않았다. 찾아보니 www를 붙여서 도메인을 입력한 경우와 붙이지 않은 경우에 따라 SSL 적용이 안되었다.

![사진1](/assets/images/ToyDev/WebServiceDev/ssl_fail1.jpg)
  
위 사진을 다시 자세히보면 `www` 를 입력하지 않아 ssl 적용이 되지않았다. 원래는 자물쇠모양이 나오고 보안연결이 되어야한다.
{: .notice--info}

1. 원인(3)
  : SSL설정파일인 httpd-ssl.conf 안에 ServerName 옵션에 나는 www.도메인.co.kr 으로 작성했었다. 이 부분도 요청에따라 명확하게 기술시켜야 했었다. (가상호스트이므로.)

2. 해결방안(3)
  : (아파치루트/conf/extra/httpd-ssl.conf) 안에서 www를 사용하지 않는 요청에대한 `<VirtualHost>` 태그를 새롭게 하나더 만들어준다.

    ```bash     
    <VirtualHost _default_:443>                                 
    
        # 가상호스 정보                                             DocumentRoot "/fswas/apache/httpd/httpd-2.4.541/htdocs"
        ServerName blang.co.kr:443
        ServerAdmin layup3@naver.com                                ErrorLog "/fswas/apache/httpd/httpd-2.4.541/logs/error_log"
        TransferLog "/fswas/apache/httpd/httpd-2.4.541/logs/access_log"
    
        #SSL 엔진
        SSLEngine on
    
        # 발급받은 SSL 인증서
        SSLCertificateFile "/etc/letsencrypt/live/www.blang.co.kr/cert.pem"
        SSLCertificateKeyFile "/etc/letsencrypt/live/www.blang.co.kr/privkey.pem"
        SSLCACertificateFile "/etc/letsencrypt/live/www.blang.co.kr/chain.pem"

        JkMount /* blang_balancer                                   

    </VirtualHost>
 
    ```

3. 해결완료(3)  
  : 접속하여 다시 확인한다. (https://www.blang.co.kr/)

  > 위 처럼 www 를 제외한 ServerName 요청에 대한 가상호스트를 추가해주니까 www 를 붙이지 않아도 
  > 정상적으로 SSL 적용이 되었다.






> ***SSL발급 후 생각***  
> cerbot(Let’s Encrypt) 을 이용한 SSL 인증서발급은 생각보다 복잡해서 시간이 많이 소요되었다.
> 특히 나의 경우는 특정 경로에 아파치를 설치해두어서 일반적으로 사람들이 소개하는 방법이 실패하여 더더욱 시간이 걸렸다.
