---
title:  "라즈베리파이(14) WEB WAS 연동"
excerpt: "라즈베리파이(14) WEB WAS 연동 입니다."
categories:
  - web-service-dev
tags:
  - [web, dev]
toc: true
toc_sticky: true

last_modified_at: 2022-10-12T20:00:00-05:00
---

# 라즈베리파이 WEB WAS 로드밸런싱
## 로드밸런싱 개요
  : 라즈베리파이에 Apache & Tomcat서버를 로드밸런싱 한다.

  - 1대의 웹서버를 바라보는 WAS서버 2대를 구성한다.
  - 물리적으로 서버를 분리하여 부하를 줄인다.
  - mod_jk의 load balancing방식은 기본적으로 round robin이지만 한번 왔던 요청은 같은 Engine에 보내준다.


## 로드밸런싱 구축
### WEB서버 mod_jk 설정
  : 웹서버(아파치) 측의 설정.

  1. (아파치루트/톰캣커넥터루트/workers.properties) 설정
    : 워커를 정의 및 로드 밸런싱을 위한 다중화 톰캣 설정을 한다.

      ```bash
      # ASIS
      # worker.list=lilo_lb                     # 리스트정의
      # worker.lilo_lb.type=lb                  # 타입정의
      # worker.lilo_lb.balance_workers=worker1  # load balancing할 worker 속성 지정, (worker1)를 lilo_lb 라는 리스트 하위에 추가한다.
      # worker.worker1.port=8009                # mod_jk 가 이용하는 APJ 연동 포트
      # worker.worker1.host=192.168.0.10        # 연동시킬 나의 다른 라즈베리파이 WAS서버 주소를 입력
      # worker.wokrer1.type=ajp13               # 연동모듈 프로토콜


      # TOBE
      worker.list=blang_balancer
      worker.blang_balancer.type=lb
      worker.blang_balancer.balance_workers=tomcat1,tomcat2

      # Server1
      worker.tomcat1.port=18009          # 로드밸런싱 전용포트 포트중첩불가 톰캣에서 설정한 포트와 일치해야함
      worker.tomcat1.host=192.168.0.10
      worker.tomcat1.type=ajp13
      worker.tomcat1.lbfactor=1          # 서버밸런스비율

      # Server2
      worker.tomcat2.port=28009
      worker.tomcat2.host=192.168.0.12
      worker.tomcat2.type=apj13
      worker.tomcat2.lbfactor=1

      ```
      
  2. (아파치루트/conf/httpd.conf) 설정
    : 톰캣에 통과시킬 매핑을 정의하는 jk마운트를 최종 설정한다.

      ```bash
      # 최종으로 mod_jk JK마운트로 worker를 등록한다. url를 구분하여 톰캣이 처리할지 결정한다.
      # /* 으로들어오는 요청을 blang_balancer 라는 워커로 넘긴다.
      # 워커 설정에는 로드밸런싱이 설정되어있다.
      # tomcat1, tomcat2 골고루 요청을 분산해줄 것이다.

      # ASIS
      #jkMount /* lilo_lb

      # TOBE
      jkMount /* blang_balancer

      ```

     
### WAS서버 mod_jk 설정
  : 와스서버(톰캣) 측의 설정.

  1. (톰캣루트/conf/server.xml) 설정
    : WAS 2대의 톰캣의 mod_jk 커넥터 포트를 겹치지 않도록 설정한다. 

      ```bash
      #(WAS 1번)
      cd /fswas/tomcat/apache-tomcat-8.5.82/conf
      vi server.xml
      
      
      # 아래 mod_jk 로드밸런싱 전용 포트를 서버별로 각각 다르게 설정한다.
      <!-- Define an AJP 1.3 Connector on port 8009 -->
      <Connector protocol="AJP/1.3"
               address="0.0.0.0"
               secretRequired="false"
               # port="8009"     # 이전에 설정한 mod_jk 연동 포트이다. 주석처리하고
               port="28009"      # 이부분은 로드밸런싱 내용이다. 이렇게 추가한다. (달라야한다)
               redirectPort="8443" />

      (중략)
      
      <!-- ASIS -->
      <!--
      <Engine name="Catalina" defaultHost="localhost">
      -->
  
      <!-- TOBE (로드밸런싱 사용시 jvmRoute 옵션으로 워커명을 준다.)-->
      <Engine name="Catalina" defaultHost="localhost" jvmRoute="tomcat1">
      
      ```
      
      ```bash
      #(WAS 2번)
      cd /fswas/tomcat/apache-tomcat-8.5.82/conf
      vi server.xml
      
      
      # 아래 mod_jk 로드밸런싱 전용 포트를 서버별로 각각 다르게 설정한다.
      <!-- Define an AJP 1.3 Connector on port 8009 -->
      <Connector protocol="AJP/1.3"
               address="0.0.0.0"
               secretRequired="false"
               # port="8009"     # 이전에 설정한 mod_jk 연동 포트이다. 주석처리하고
               port="28009"      # 이부분은 로드밸런싱 내용이다. 이렇게 추가한다. (달라야한다)
               redirectPort="8443" />

      (중략)
      
      <!-- ASIS -->
      <!--
      <Engine name="Catalina" defaultHost="localhost">
      -->
  
      <!-- TOBE (로드밸런싱 사용시 jvmRoute 옵션으로 워커명을 준다.)-->
      <Engine name="Catalina" defaultHost="localhost" jvmRoute="tomcat2">
      
      ```
      
