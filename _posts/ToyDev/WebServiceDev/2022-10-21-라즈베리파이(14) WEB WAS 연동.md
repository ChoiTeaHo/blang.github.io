---
title:  "라즈베리파이(14) WEB WAS 연동"
excerpt: "라즈베리파이(14) WEB WAS 연동 입니다."
categories:
  - web-service-dev
tags:
  - [web, dev]
toc: true
toc_sticky: true

last_modified_at: 2022-10-12T20:00:00-05:00
---

# 라즈베리파이 WEB WAS 연동
## 연동 개요
  : 라즈베리파이에 Apache & Tomcat서버를 연동한다.

  - Apache (웹 서버) 는 static한 파일 (js, img, css) 등 변동이 없는 파일을 서비스하기 위해 사용되어 왔다. 
  - Tomcat (웹 어플리케이션 서버, 이하 WAS) 는 사용자의 요청 등에 따라 유동적인 서비스를 제공하기 위해 사용한다. 

**참고)**  
WEB은 static 파일 서비스에 유리하고, WAS는 동적인 서비스를 제공하는데 유리하다. 
톰캣은 WAS 이지만 Web 서버의 기능도 갖고 있다. 그러나 톰캣의 Web 서버 기능은 아파치보다 처리 속도가 느리기 때문에 정적인 페이지는 아파치가 처리하고, 동적인 페이지는 톰캣이 처리하도록 한다. 이렇게 하므로 부하를 분산시킬 수 있다.  (물리적 분리 외부망: WEB, 내부망: WAS)
{: .notice--info }


## 연동 종류
  : 다양한 연동방법이 존재했다. 나는 mod_jk 를 이용한 연동방식으로 진행한다. mod_proxy는 AJP 같은 특정 프로토콜에 의존하지 않고, 설정이 간편하며, 성능상 우위를 점하고 있지만, mod_jk를 이용한 방식이 전통적으로 널리 쓰이고 있기에 선택했다.

- 종류
  - Tomcat Connector를 이용한 mod_jk 연동 (AJP)
  - mod_proxy를 이용한 reverse proxy 기능으로 연동 (Proxy 개념 필요)
  - mod_proxy_ajp를 이용한 AJP를 reverse proxy로 사용해서 연동 (기존의 2가지 방법 모두 개념이 필요함)


> **mod_jk 모듈이란?**  
> AJP프로토콜을 사용하여 톰캣과 연동하기 위해 만들어진 모듈이다.  
> 아파치에 들어온 요청 중 톰캣이 처리할 요청을 AJP 포트(일반적으로 8009)를 통해 톰캣에 전달하고 그에 대한 응답을 받는 역할을 수행한다.
> mod_jk는 톰캣에서 배포되므로 톰캣 홈페이지에서 tomcat-connector 이라는 파일로 다운 받을 수 있다.  
> 참고로 mod_jk는 아파치 웹서버에 설치해주어야 한다.


## 연동시 흐름
  : 흐름을 요약하자면 다음과 같다.

- 요약
  1. `web서버` 에 주소를 입력하면 정적페이지를 로드한뒤 `was서버` 내부의 동적페이지가 호출되도록 연동을 목적한다.
  2. 흐름은 web서버(80포트)를 거쳐서 요청한 특정 확장자 파일은 특정포트인 was서버(8080포트)로 바인딩한다.
  3. 이렇게 http://주소:8080 포트로 WAS로 직접접속이 아닌 http://주소:80// 포트로 WEB로 접속을통해 WAS로 접근하도록 한다.

- 상세
  1. 아파치 웹서버의 httpd.conf 파일에서 톰캣 연동을 위한 설정을 추가하고 톰캣에서 처리할 요청을 지정한다.
  2. 사용자의 브라우저는 아파치 웹서버에 접속하여 요청한다. (통상 80 port )
  3. 아파치 웹서버는 사용자의 요청이 들어왔을때, 이 요청이 톰캣에서 처리되도록 지정된 요청인지 확인한다.
  4. 톰캣에서 처리해야하 하는 경우 (예를들어 특정 확장자인 경우) 아파치 웹서버는 톰캣의 `AJP 포트(통상 8009 port)` 에 접속해 요청을 톰캣에게 전달한다. 
  5. 톰캣은 아파치 웹서버로부터 요청을 받아 처리한 후, 처리 결과를 다시 아파치 웹서버에게 돌려준다. 아파치 웹 서버는 톰캣으로 전달받은 처리 결과를 사용자에게 전송한다.


## mod_jk 구축
### mod_jk 설치
  : 본격적으로 연동모듈을 다운로드하고 설치하자.
  
1. JK connector(mod_jk) 다운로드
  : 공식 홈페이지에서 소스링크를 복사한다. ([링크](https://tomcat.apache.org/download-connectors.cgi))

    ```bash
    cd /fswas/insatall
    wget [mod_Jk 소스 링크]  #소스파일 다운로드 완료
    
    mkdir /fswas/apache/tomcat-connectors  # mod_jk 설치할 폴더 생성
    cd /fswas/apache/tomcat-connectors/    
    tar -zxf tomcat-connectors-1.2.48-src.tar.gz  # mod_jk 압축해제
        
    ```

2. JK connector(mod_jk) 컴파일
  : 소스 컴파일 설치한다.

    ```bash
    # 압축해제한 폴더에서 Tomcat Connector 홈/native 디렉터리로 이동     
    cd /fswas/apache/tomcat-connectors/tomcat-connectors-1.2.48-src/native/

    # configure 명령어를 통해 의존성패키지 설치경로(이전에 아파치 의존성패키지로 설치해둔 경로/bin/apxs)를 포함한 make 파일을 생성한다.
    ./configure --prefix=/fswas/apache/tomcat-connectors 
        --with-apxs=/fswas/apache/httpd/bin/apxs

    # 컴파일 설치
    make && make install
 
    ```
 
3. 정상설치 확인 (연동모듈 `mod_jk.so` 생성확인)
  : 정상적으로 설치 되었는지 확인한다.

    ```bash
    cd /fswas/apache/modules
    ls | grep mod_jk.so
    
    # 존재하면 정상적으로 설치완료다.
    
    ```

> **참고)**  
> 여기까지 완료하면 `아파치홈/modules` 경로안에 `mod_jk.so` 파일이 생성된다.
> 이 파일이 있는지확인해야한다.


## mod_jk 연동설정
  : 설치를 완료했으면 연동을 위한 설정이 필요하다.

- WEB
  1. httpd.conf 파일설정
    : mod_jk를 연동하는 설정과 mod_jk.conf의 경로를 지정하여 요청 처리에 대한 설정 및 로그 파일 등을 기술한다.

      ```bash
      #LoadModule rewrite_module modules/mod_rewrite.so
      # httpd.conf 내용 중 LoadModule... 바로 아래에 설정호출을 작성했다.
      
      # mod_jk 설정호출 (mod_jk Connector)
      Include /fswas/apache/tomcat-connectors/tomcat-connectors-1.2.48-src/conf/httpd-jk.conf
        
      # 사람마다 설정을 작성하는 방법은 다르겠지만 (httpd.conf 안에 한번에 작성하는 등..)
      # 나는 위 처럼 mod_jk 설치시 기본적으로 포함되어있는 httpd-jk.conf 파일을 include 하는것으로 한번에 끝냈다.
      # 즉, 이 설정파일에 기본설정이 어느정도 기록이 되어있어서 약간의 수정으로 쉽게 반영했다.
      # 요즘엔 mod_jk 패키지에 이렇게 기본설정이 포함되어서 나오나보다.

      ```

      *참고) mod_jk 패키지에 기본적으로 들어있었던 설정파일*  
      httpd-jk.conf  
      uriworkermap.properties  
      workers.properties
      {: .notice--info}

  2. mod_jk.conf 파일설정
    : 앞서 설명했듯이 관례적인 파일로 하지않고(mod_jk.conf 가 아닌) 패키지에서 제공하는 기본설정파일 httpd-jk.conf 를 활용했다.  (앞에서 httpd.conf 파일로 부터 호출되도록 작성했었다.)

      [사진1](/assets/images/ToyDev/WebServiceDev/httpd-jk.conf.jpg)

      ```bash
      <IfModule jk_module>
          (중략)
          # Apache를 시작할 때 모듈을 로드할 위치 정의
          LoadModule jk_module modules/mod_jk.so
       
          # 워커(Worker) 파일 경로를 적어준다.
          JkWorkersFile /fswas/apache/tomcat-connectors/tomcat-connectors-1.2.48-src/conf/workers.properties

          # 연동모듈의 로그를 생성시킬 경로를 적어준다.
          JkLogFile /fswaslog/apache/dbd/mod_jk.log
          JkShmFile /fswaslog/apache/dbd/mod_jk.shm

      <IfModule jk_module>

      ```

  3. workers.properties 설정
    : 요청을 처리할 톰캣 인스턴스들을 정의하는 중요한 핵심 파일이다. 예를 들어 컨텍스트 별로 각각 톰캣을 구성하기 위한 설정을 하거나, 로드 밸런싱을 위한 다중화 톰캣 설정을 할 수 있다.  (앞에서 mod_jk.conf 파일로 부터 호출되도록 작성했다.)

      ```bash
      worker.list=lilo_lb     # 리스트정의
      worker.lilo_lb.type=lb  # 타입정의
      worker.lilo_lb.balance_workers=worker1  # 이름정의
      worker.worker1.port=8009          # mod_jk 가 이용하는 APJ 연동 포트
      worker.worker1.host=192.168.0.10  # 연동시킬 나의 다른 라즈베리파이 WAS서버 주소를 입력 
      worker.wokrer1.type=ajp13         # 연동모듈 프로토콜

      ```




### 수동설치 (소스컴파일 방식)
  : 소스컴파일방식의 수동설치를 진행한다.

1 공식홈페이지 톰캣 링크복사
  :  톰캣을 링크를 복사한다. (현재 기준 8.5.82 버전으로 Core 부분에서 tar.gz 우클릭하고 복사한다.)

2 wget [링크] 명령어로 컴파일소스 다운로드
  : 서버에 tar.gz 압축파일을 바로 다운로드 한다. (다운받은 tar.gz 는 관리하기 쉽게 별도 생성한 install 폴더에 넣었다.)

```bash
sudo apt-get update && sudo apt-get upgrade  #패키지 업데이트 선행

mkdir /fswas/install  # 톰캣압축보관 위치
cd /fswas/install
wget [복사한 링크]

```

3 다운받은 tar.gz 압축파일을 해제
  : gunzip 명령어로 해제한다. (톰캣이라는 대분류폴더를 생성하고 그 안에 해제했다.)
  
```bash
mkdir /fswas/tomcat
mv /fswas/install/apache-tomcat-8.5.82.tar /fswas/tomcat  # 톰캣압축해제 위치
cd /fswas/tomcat
gunzip apache-tomcat-8.5.82.tar

# .gz를 풀었으니 .tar만 해제하면 된다.
cd /fswas/tomcat
sudo tar -xvf apache-tomcat-8.5.82.tar

# Tomcat은 정기적으로 업데이트되므로 버전 및 업데이트를 보다 효과적으로 제어하기 위해 Tomcat 설치 디렉토리를 가리키는 최신 버전이라는 심볼 링크를 만든다. ex) lastver
sudo ln -s /fswas/tomcat/apache-tomcat-8.5.82 /fswas/tomcat/lastver
export TOMCAT_HOME=/fswas/tomcat/lastver  # 환경변수 설정해두면
cd $TOMCAT_HOME                           # 이렇게 어디서든 접근할 수 있다. (적용은 env 명령어로 확인.)

```

4 설치 완료
  : 특정 경로에 압축만 풀면 설치 완료이다.

5 실행
  : 톰캣서버를 실행한다.

```bash
sudo sh /fswas/tomcat/apache-tomcat-8.5.82/bin/startup.sh

```

## Tomcat 톰캣 권한
### 톰캣 디렉토리 권한 부여
  : 설치를 완료했으므로 실행, 중지를 위해 특정계정에게 WSA관련한 모든 디렉토리에 권한을 준다. 나는 wasadm 이라는 웹관리자 계정에게 권한을 위임했다.

```bash
# 아파치가 설치된 폴더전체에 웹관리자계정 권한을 준다.
sudo chown -R wasadm:wasadm /fswas  # 옵션 -R 로 하위폴더 전체 변경

```

### 톰캣 재기동 쉘(루트대여) 권한 부여
  : wasadm 계정이 재기동시 폴더 권한을 가져도 root권한이 없으면 안되는것으로 확인된다. wasadm에게 sudo 권한을 준다.

```bash
su
vi /etc/sudoers

# User privilege specification

root    ALL=(ALL:ALL) ALL
pi      ALL=(ALL:ALL) ALL
dbd000  ALL=(ALL:ALL) ALL
wasadm  ALL=(ALL:ALL) ALL   # 이렇게 추가

```

## Tomcat 톰캣 쉘 스크립트
### 쉘 스크립트 생성
  : 재기동, 상태체크 쉘 스크립트를 생성한다.
  
```bash
cd /fswas/wasadm/script/dbd
touch was_check.sh was_start.sh was_stop.sh   //시작, 종료, 상태체크 쉘파일 생성

# 쉘파일 작성
touch was_start.sh  # 서버시작
## 내용: sudo sh /fswas/tomcat/apache-tomcat-8.5.82/bin/startup.sh

touch was_stop.sh   # 서버중지
## 내용: sudo sh /fswas/tomcat/apache-tomcat-8.5.82/bin/shutdown.sh

touch was_check.sh  # 서버상태체크
## 내용: echo '================> ps -ef | grep java'
         ps -ef | grep java
         echo ''
         echo '================> netstat -anp | grep java'
         sudo netstat -anp | grep java

```

### 쉘 스크립트 전역alias 등록
  : 어디서든 실행 가능하도록 alias를 등록한다.

```bash
# alias 등록
vi /etc/bash.bashrc
alias wasstop='sh /fswas/wasadm/script/dbd/was_stop.sh'
alias wasstart='sh /fswas/wasadm/script/dbd/was_start.sh'
alias wascheck='sh /fswas/wasadm/script/dbd/was_check.sh'

# 적용
source /etc/bash.bashrc

```

## 라즈베리파이 포트포워딩 설정
  :  아직 웹서버 라즈베리파이와 연결하지 않았기 때문에 접속할 방법이 없다. 임시방편으로 외부에서는 어떤것이 라즈베리파이 서버인지 포트포워딩으로 알려주도록 한다.
  
  > **테스트용으로 다음과 같이 포트포워딩 임시설정했다.**  
  > 외부포트 9191 ==> 내부포트 8080  
  > 재부팅 후 9191 포트로 들어오면 was서버로 직접 접근한다.
  >  
  > (이제 본격적으로 WEB WAS를 연동해야할것이다.)
