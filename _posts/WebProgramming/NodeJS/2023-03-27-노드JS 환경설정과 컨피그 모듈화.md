---
title:  "노드JS 환경설정과 컨피그 모듈화"
excerpt: "노드JS 환경설정과 컨피그 모듈화 입니다."

categories:
  - nodejs
tags:
  - [node.js]

toc: true
toc_sticky: true

last_modified_at: 2023-03-24T20:00:00-05:00
---

## 개요
환경설정 값들을 따로 모아 관리를 해야 할 필요성을 느낀다.  
나의 경우 JAVA, SPRING 에서 properties를 여러 개(로컬, 개발, 스테이징, 운영) 만들어서 운영했던 것 처럼 구현이 필요하다.
  


## 컨피그파일 유형
대표적인 컨피그 파일 유형은 아래와 같다.

1. *.json
2. .env
3. *.yml (YAML files)
4. *.ini (normally Windows-only)

위 파일들을 관리하기 위해 컨피그(Config) 파일 관리 디렉토리 생성
  
```bash
mkdir /config

```

## 컨피그파일 네이밍
보통 설정 파일 이름에서는 - 대신 .을 사용하는 것이 일반적이다.  


### JAVA에서 자주 사용되는 설정파일 네이밍
properties라는 단어는 일반적으로 Java의 properties 파일에서 많이 사용되는 용어였다.

- properties-dev
- properties-prod
- properties.dev
- properties.prod

### Node.js 에서 자주 사용되는 설정파일 네이밍
하지만 <span style='color:red'>Node.js에서는 그다지 일반적이지 않다고 한다.</span>

1. config.js
2. .env.development
3. .env.production

    production: 파일 캐싱, 에러 메시지 감추기 등 배포의 적합한 환경 설정  
    development: 개발에 도움을 줄 수 있는 환경 설정
    {: .notice--info}
    

### 정리
자바던 노드던 properties-dev 또는 properties.dev와 같은 이름을 선택해야 한다면, 일반적으로는 properties.dev와 같은 형태가 더 많이 사용된다. - 대신 .을 사용하는 것이 일반적이며, .dev와 같은 확장자를 사용하여 개발 환경을 구분하는 것이 일반적이다.


## 노드JS 의 환경변수
```bash
# Linux 환경변수 (전체)
$ env

```

```bash
# Node.js 의 환경변수 (전체)
> process.env

```
위 리눅스OS 환경변수 처럼 <span style='color:red'>노드JS 에서도 환경변수를 관리한다.</span> 기본적인 사용방법은 다음과 같다.

```bash
# Node.js 환경변수 정의
PORT=3000 node

# Node.js 환경변수 확인
> process.env
{
  PORT: '3000',
  SHELL: '/bin/bash',
  JAVA_HOME: '/usr/lib/jvm/java-8-openjdk-armhf',
  (중략...)  
}

# Node.js 환경변수 사용(기본)
> process.env.PORT
'3000'

# Node.js 환경변수 사용(자바스크립트)
# const { PORT, DB_PASSWORD } = process.env;  // 2줄인 경우
> const PORT = process.env.PORT;
> console.log('PORT:', PORT);

# Node.js 환경변수 사용(오버라이드)
$ PORT=2000 node    # 기존값 대체 1회성
> process.env.PORT
'2000'
>

```

> Node.js에서는 보통  <span style='color:blue'><b>process.env</b></span>를 통해서 환경 변수에 접근한다.  
> . process는 Node.js에 기본적으로 내장된 전역 객체여서 별도로 불러올(import) 필요없이 프로그램의 
> 어디에서든지 사용할 수 있다.  


### 환경변수 목적
- 로컬, 개발, 운영 환경별로 매번 수정해서 배포하는 것은 쉽지 않다. 
- 데이터베이스의 비밀번호나 서드파티(3rd-party) 서비스의 API 키, DB 연결, 포트 설정 등의 <span style='color:red'>민감한 인증 정보</span>는 <span style='color:red'>GitHub와 같은 코드 저장소(repository)에 올리면 상당히 위험</span>할 수 있기 때문에 대상 <span style='color:red'>보통 OS환경에서 환경 변수로 저장해놓고 사용하는 것이 권장</span>된다.



## 환경변수 구현방법 종류
1. OS 환경변수 구현
2. .env 환경변수 구현
3. config 모듈 환경변수 구현
4. json 환경변수 구현

> 위 내용에서 1번, 2번 내용을 상세하게 다루겠다.  
> 참고로 특히 env 방식이 자주 사용되는듯 하다.



## STEP1. OS 환경변수 사용하기
```bash
# OS 레벨에서 단순 환경설정하므로 추가적인 TREE 없음.
```
### 과정
1. OS 환경변수 export 
2. Node 프로세스에서 환경변수 가져오기
3. OS레벨 환경변수 영구저장
4. 최종 NODE_ENV 생성하기

### (1) OS 환경변수 export 
```bash
# 노드 프로세스에서 적용한 환경변수는 재시작하면 사라진다. 그래서 OS환경변수를 적용한다.
$ node
> process.env.PORT
undefined 

```

Node.js 인터프리터를 재실행하면 이 전에 실행할 때 명시했던 환경 변수를 못얻고 있다..!
즉, 프로그램 실행 시 설정해준 환경 변수는 해당 프로그램이 실행되는 동안에만 유효하며 프로그램이 종료하면 소멸된다. 
  
더 깊은 레벨인 OS 단에서 환경변수를 설정해주면 process.env 에서 인식이 가능하다.  
물론 이 기능은 터미널이 꺼지기 전까지 작동한다.

```bash
# OS레벨에서 환경변수 export
$ export PORT=3000

```

### (2) Node 프로세스에서 환경변수 가져오기
```bash
# OS레벨의 환경변수를 Node가 인식한다.
$ node
> process.env.PORT
'3000'

```

### (3) OS레벨 환경변수 영구저장
이미 알고있겠지만 리눅스가 리붓되면 환경변수는 사라진다. 아래와 같이 환경변수를 영구적으로 저장하자.  
  
```bash
# 리눅스 환경변수 영구적으로 저장하기
$ vi ~/.bashrc
$ export PORT=3000
$ source ~/.bashrc # 또는 $sudo reboot

```

> ***리눅스를 다룬다면 아래 내용은 기본적으로 알고있자. :)***  
> 로긴후 터미널 오픈시점 수행 파일
> - 전체계정: etc/bash.bashrc  
> - 특정계정: 계정홈디렉토리/.bashrc  

### (4)최종 NODE_ENV 생성하기
```bash
export NODE_ENV=development

```



## STEP2. .env 환경변수 구현
node.js에서 dotenv 모듈을 통해 직접 OS 환경변수를 설정하지 않고도 .env파일에서 설정 값을 불러와 process.env.NAME의 형태로 환경변수로 사용할 수 있다.  

***장점***
- OS 레벨에서 관리하지 않아도 된다.
- dotenv의 공식문서는 n개의 .env파일을 가지는 않을것 을 강력히 권고 하고있다. 즉, .env파일은 하나만 가지므로 한번만 .gitignore에 추가해주면 된다.

***단점***
- 관리 파일이 딱 1개 이지만 .env파일 역시 config 파일과 마찬가지로 버전 관리 시스템에 공유되지 않도록 신경 써줘야하는 번거로움이 존재한다.
    > 환경설정 파일은 .gitignore에 추가하여 못보게 해야한다.

```bash
.
├── .env    # .env파일을 루트에 생성한다.
├── app.js
└── config
(중략)

```

***잠깐)***  
이전에 설정한 OS환경변수를 제거 잊지말자 :)  
<span style='color:blue'><b>$ unset PORT</b></span>  
{: .notice--info}

### 과정
1. .env 파일 생성
2. dotenv 라이브러리를 설치
3. 환경변수 로드(.env 참조)
4. .gitignore 등록
5. 최종 NODE_ENV 생성하기


### (1) .env 파일 생성
***/.env***
```bash
# 환경변수 정의
PORT=3000

```

### (2) dotenv 라이브러리 설치
```bash
npm install dotenv

```

### (3) 환경변수 로드(.env 참조)
***/server.js***
```js
require('dotenv').config();  // 모듈을 통해 .env 환경변수를 임포트
const app = require('./app.js');
//const PORT = 3000;         // AS-IS 주석처리
const PORT = process.env.PORT  // OS없이 환경변수 사용이 가능해졌다!

app.listen(PORT, () => {
    console.log('서버가 실행됩니다.. http://127.0.0.1:' + `{PORT}` + '/');
});

```
 
> .env파일이 process.env에 로드 되기 전에 접근하게 되면 undefined 되므로 
> .env를 불러오는 코드는 가능한 코드의 최상단의 위치시켜주는 것을 권장한다.


### (4) .gitignore 등록
```bash
node_modules
.env # 등록 (GIT 업로드시 필터링)

```


### (5)최종 NODE_ENV 생성하기
```bash
export NODE_ENV=development

```

> .env 파일과 dotenv 모듈로 설정파일 구현완료


## CASE3. config 모듈 환경변수 구현
해당 내용은 진행하지 않고 과정만 소개한다.

### 과정
1. default.json 파일 생성
2. config 라이브러리를 설치
    - npm install config 
3. 환경변수 로드(.default 참조)
    - const config = require('config');
    - const dbUrl = config.get('DATABASE_URL');
4. 최종 NODE_ENV 생성하기

> config 라이브러리로 설정파일 구현완료


## CASE4. json 환경변수 구현
```bash
mkdir /config/conf_json
touch /config/conf_json/application.local.json
touch /config/conf_json/application.dev.json
touch /config/conf_json/application.prod.json

```

```bash
└── config
     ├── conf_json
        ├── application.dev.json
        ├── application.local.json
        └── application.prod.json

```

### /config/conf_json/application.local.json
```json
{
  "serverPort": 3000, 
  "database": {
      "user": "admin", 
      "pw": "123"
  }
}

```

### /server.js
```json
const fs = require('fs');
const config = JSON.parse(fs.readFileSync('./config/conf_json/application.local.json', 'utf-8'));

console.log(config);  //{ serverPort: 3000, database: { user: 'admin', pw: '123' }}
console.log(config.serverPort);     //3000
console.log(config.database.user);  //admin

```

> JSON 파일로 설정파일 구현완료





## NODE_ENV 환경 분기
### 방법
1. 환경설정으로 분기
2. package.json 정의 내용으로 분기

### 미정/app.js
```js
// NODE_ENV 가 따로 지정이 안되어 있더라도 development 모드로 지정
process.env.NODE_ENV = process.env.NODE_ENV || 'development';

// 이후 사용
if (process.env.NODE_ENV == 'production') {
  module.exports = require('./prod') ; //운영
} else if (process.env.NODE_ENV == 'development') {
  module.exports = require('./dev');  //개발
}
const env = 
```

### 미정/dev.js
```js
// 개발 서버
module.exports = {
    mongoURI:'개인 mongoDB'
};

```

### 미정/prod.js
```js
// 운영 서버
module.exports = {
    mongoURI: process.env.MONGO_URI
};

```














