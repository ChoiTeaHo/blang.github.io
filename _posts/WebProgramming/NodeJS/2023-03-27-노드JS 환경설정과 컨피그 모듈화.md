---
title:  "노드JS 환경설정과 컨피그 모듈화"
excerpt: "노드JS 환경설정과 컨피그 모듈화 입니다."

categories:
  - nodejs
tags:
  - [node.js]

toc: true
toc_sticky: true

last_modified_at: 2023-03-24T20:00:00-05:00
---

## 개요
환경설정 값들을 따로 모아 관리를 해야 할 필요성을 느낀다.  
나의 경우 JAVA, SPRING 에서 properties를 여러 개(로컬, 개발, 스테이징, 운영) 만들어서 운영했던 것 처럼 구현이 필요하다.
  


## 컨피그파일 유형
대표적인 컨피그 파일 유형은 아래와 같다.

1. *.json
2. .env
3. *.yml (YAML files)
4. *.ini (normally Windows-only)

위 파일들을 관리하기 위해 컨피그(Config) 파일 관리 디렉토리 생성
  
```bash
mkdir /config

```

## 컨피그파일 네이밍
보통 설정 파일 이름에서는 - 대신 .을 사용하는 것이 일반적이다.  


### JAVA에서 자주 사용되는 설정파일 네이밍
properties라는 단어는 일반적으로 Java의 properties 파일에서 많이 사용되는 용어였다.

1. properties-dev, properties-prod
2. properties.dev, properties.prod


### Node.js 에서 자주 사용되는 설정파일 네이밍
하지만 <span style='color:red'>Node.js에서는 그다지 일반적이지 않다고 한다.</span>

1. config.js
2. .env.development


### 정리
자바던 노드던 properties-dev 또는 properties.dev와 같은 이름을 선택해야 한다면, 일반적으로는 properties.dev와 같은 형태가 더 많이 사용된다. - 대신 .을 사용하는 것이 일반적이며, .dev와 같은 확장자를 사용하여 개발 환경을 구분하는 것이 일반적이다.


## 노드JS 의 환경변수
우리는 전용 서버에 환경 변수 설정하여 늘 사용해왔다. JDK의 경우 다음과 같다.  

```bash
export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-armhf  
export PATH=$PATH:$JAVA_HOME/bin

```

위와 같이 노드JS 에서도 권장하는 환경변수가 있다.

### 환경변수 목적
데이터베이스의 비밀번호나 서드파티(3rd-party) 서비스의 API 키와 같이 민감한 인증 정보는 GitHub와 같은 코드 저장소(repository)에 올리면 상당히 위험할 수 있기 때문에 대상 OS환경에서 환경 변수로 저장해놓고 사용하는 것이 권장된다.


### 환경변수 정의 및 사용
> <span style='color:blue'><b>키=값 node</b></span>

node 명령어 앞에 환경 변수를 키=값 형태로 붙이면 된다.  

```bash
# 정의
PORT=3000 node

# 확인
> process.env
{
  PORT: '3000',
  SHELL: '/bin/bash',
  JAVA_HOME: '/usr/lib/jvm/java-8-openjdk-armhf',
  (중략...)  
}

# 사용(기본)
> process.env.PORT
'3000'

# 사용(자바스크립트)
# const { PORT, DB_PASSWORD } = process.env;  // 2줄인 경우
> const PORT = process.env.PORT;
> console.log('PORT:', PORT);

# 사용(오버라이드)
$ PORT=2000 node    # 기존값 대체 1회성
> process.env.PORT
'2000'
>

```

Node.js에서는 보통 process.env를 통해서 환경 변수에 접근한다.  
. process는 Node.js에 기본적으로 내장된 전역 객체여서 별도로 불러올(import) 필요없이 프로그램의 어디에서든지 사용할 수 있다.  

### 환경변수 생명주기
```bash
# 노드 프로세스에서 적용한 환경변수는 재시작하면 사라진다.
$ node
> process.env.PORT
undefined 

```
Node.js 인터프리터를 실행하면 이 전에 실행할 때 명시했던 환경 변수를 못얻고 있다..!
즉, 프로그램 실행 시 설정해준 환경 변수는 해당 프로그램이 실행되는 동안에만 유효하며 프로그램이 종료하면 소멸된다. 
  
더 깊은 레벨인 OS 단에서 환경변수를 설정해주면 process.env 에서 인식이 가능하다.  
물론 이 기능은 터미널이 꺼지기 전까지 작동한다.

```bash
# OS레벨에서 환경변수를 설정해주니까 인식한다.
$ export PORT=3000

$ node
> process.env.PORT
'3000'

```
  
이미 알고있겠지만 리눅스가 리붓되면 환경변수는 사라진다. 아래와 같이 환경변수를 영구적으로 저장하자.  
  
```bash
# 리눅스 환경변수 영구적으로 저장하기
$ vi ~/.bashrc
$ export PORT=3000
$ source ~/.bashrc # 또는 $sudo reboot

```

> ***리눅스를 다룬다면 아래 내용은 기본적으로 알고있자. :)***  
> 로긴후 터미널 오픈시점 수행 파일
> - 전체계정: etc/bash.bashrc  
> - 특정계정: 계정홈디렉토리/.bashrc  


## CASE1. JSON 컨피그 구현
```bash
touch /config/application-local.json
touch /config/application-dev.json
touch /config/application-prod.json

```

### /config/application-dev.json
그리고 운영 환경에 따라서 파일을 적용하기 위해서 node js에서는 NODE_ENV라는 환경변수를 사용합니다.
json 파일은 각각 만들어 주시고 json 파일을 불러와야 하는데 node js에서 json 파일을 불러오는 법은 쉽습니다!




## STEP1. 환경변수(process.env.NODE_ENV) 구현
### OS 환경변수 생성
```bash
export NODE_ENV=production

```

### 사용예시
```js
const env = process.env.NODE_ENV || 'development';

if (env === 'production') {
  console.log('Running in production mode');
} else {
  console.log('Running in development mode');
}

```


> process.env.NODE_ENV가 설정되어 있지 않은 경우 기본값으로 development 가 할당된다.


## STEP2. *.json을 이용한 방법



## STEP3. .gitEgnore
```
다섯 번째. .gitignore 파일 생성.
——
touch .gitignore
——
.gitignore 을 생성해주고, 안에 /node_modules 을 입력.
——
/node_modules
——
=> 이게 뭔 소리냐. 프로젝트를 git 에 업로드 할 건데, zoom 폴더 안의 node_modules 는 업로드 하지 않겠다 라는 의미. 업로드 하면 미친 짓.
```


## STEP4. *.env 이용방법
### dotenv 패키지를 설치
```bash
npm install dotenv #.env 파일에서 환경 변수를 로드하는 패키지

``` 

### .env 파일 작성
```js
  #PROJECT config
  NODE_MODE=dev

  #DB config
  host = blang.co.kr,
  port = 3306,
  user = "INSTC",
  password = "a",
  database := "DSDBDO0",
  connectionLimit: 10

```

### .env 파일에서 로드된 환경 변수를 사용
```js
/**
 * express.static, 정적 파일 서비스 제공
 */
//path.resoleve : os에 따라 /public 혹은 \public 처럼 분리자가 다를 수 있지만 이 부분을 처리해 준다.
//__dirname : 현재 위치를 가리키는 node 전역변수
var path = require("/config");
var publicPath = path.resolve(__dirname, "public");

require('dotenv').config()

```

주의할 점은 dotenv 패키지를 사용하기 전에 .env 파일을 만들고 환경 변수를 정의해야합니다. 그렇지 않으면 dotenv 패키지를 사용하여 환경 변수를 로드 할 수 없습니다.



