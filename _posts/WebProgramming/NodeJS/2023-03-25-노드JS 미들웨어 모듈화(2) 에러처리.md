컨트롤러
title:  "노드JS 미들웨어 모듈화(2) 에러처리"
excerpt: "노드JS 미들웨어 모듈화(2) 에러처리 입니다."

categories:
  - nodejs
tags:
  - [node.js]

toc: true
toc_sticky: true

last_modified_at: 2023-03-24T20:00:00-05:00
---

## 들어가기전에
앱을 구성할 때는 위에서부터 아래로 순서대로 실행되기 때문에

1) 공통 미들웨어: 모든 라우트에서 사용하는 
2) 범위가 좁은 라우트: path variable을 사용하는 
3) 범위가 넓은 라우트: query String을 사용하는
4) 에러 처리 미들웨어 

순으로 작성해야한다.


## 에러처리 미들웨어
노드는 싱글 스레드이기 때문에, 에러 처리에 민감해야 한다.

### 에러처리 미들웨어 목적
1. 에러를 처리한다.
2. 에러페이지 내용을 숨긴다.
    ```bash
    # 아래와 같은 에러 페이지 내용을 숨기자
    Error: 
        at /fswas/wasadm/nodeStudy/app_temp.js:19:10
            at Layer.handle [as handle_request] (/fswas/wasadm/nodeStudy
            ......(중략)
          
    ```

## Express 제공 에러처리 미들웨어
에러 핸들링을 위한 미들웨어어 알아본다. <span style='color:red'>Express에서 제공하는 next 함수의 인자로 에러 객체를 전달</span>하면, 에러 핸들러 미들웨어에서 처리할 수 있다.

### app.js
```js
const express = require('express');
const PORT = 3000;
const logger = require('./middlewares/logger');
const customErr = require('./middlewares/customErr');

class App {
    constructor() {
        this.app = express();
        this.setMiddlewares();
        this.setRouting();
	
        //특수한 Express 에러처리 미들웨어 생명주기로 인한 별도로 맨 마지막 등록
        this.app.use(customErr);
    }
    
    setRouting() {
        const routes = require('./routes'); 
        this.app.use('/', routes);
    }
    
    setMiddlewares() {
        this.app.use(logger);
    }
    
}

module.exports = new App().app;

```


### routes/member/basic/index.js
```js
const express = require('express');
const router = express.Router({mergeParams: true}); // (기본값false)부모의 매개변수를 상속받도록 함

router.get('/detaile/:name/:age', (req, res) => {
    console.log('basic/index.js detaile start  >> ');
    console.log('name: ' + req.params.name);
    console.log('age: ' + req.params.age);
});

router.get('/errTest', (req, res) => {
    console.log('basic/index.js errTest start  >> ');
    throw new Error('강제 익셉션이 발생되었습니다.');
});

module.exports = router;

```

***결과)***   
```bash
# 클라이언트 접속 (http://호스트:포트/member/errTest)
GET /member/errTest
basic/index.js errTest start  >>
에러처리 미들웨어 발동

```
Express에서 에러 처리 미들웨어는 4개의 인자로 `오버로딩` 되어 구현되어있다.  
이 미들웨어의 특이한 점은 next() 함수를 호출하지 않아도 된다. 이는 다른 미들웨어와 달리, 요청 처리 결과에 영향을 미치지 않는 특수한 미들웨어이기 때문이다.  

1. app.use를 사용하여 등록 한다.
    - 첫 번째 인자를 err(에러) 객체로 하여 총 4개의 인자를 부여 해야한다.

2. 특수한 미들웨어라서 일반적으로, 모든 미들웨어 다음줄 `code line` 에 등록하며, 요청 처리 중 발생하는 에러를 처리한다. 아래는 호출되는 예시다.
    - next(err) 함수를 호출한 경우
        ```js
        // 실제 미들웨어 내용을 까보면 아래 내용이 구현되어 있을것이다.
        try {
    	   // .. 에러 발생 코드
        } catch(err) {
  	      error(err); // next()에 인수가 있다면, 에러 처리 미들웨어로 점프한다.
        }

        ```
    - 라우터 함수나 미들웨어 함수 내부에서 에러가 발생한 경우

3. 에러가 발생한 경우 이후의 미들웨어는 실행되지 않고, 바로 에러 처리 미들웨어로 전달 된다.
    - /errRun 을 요청해보면 결과는 다음과 같다.
        ```bash
        의도한 익셉션 수행
        Error: 에러는 에러 처리 미들웨어로 갑니다.
            at /fswas/wasadm/nodeStudy/app_temp.js:19:10
            at Layer.handle [as handle_request] (/fswas/wasadm/nodeStudy/node_modules/express/lib/router/layer.js:95:5)
            at next (/fswas/wasadm/nodeStudy/node_modules/express/lib/router/route.js:144:13)
            at Route.dispatch (/fswas/wasadm/nodeStudy/node_modules/express/lib/router/route.js:114:3)
            at Layer.handle [as handle_request] (/fswas/wasadm/nodeStudy/node_modules/express/lib/router/layer.js:95:5)
            at /fswas/wasadm/nodeStudy/node_modules/express/lib/router/index.js:284:15
            at Function.process_params (/fswas/wasadm/nodeStudy/node_modules/express/lib/router/index.js:346:12)
            at next (/fswas/wasadm/nodeStudy/node_modules/express/lib/router/index.js:280:10)
            at Layer.handle [as handle_request] (/fswas/wasadm/nodeStudy/node_modules/express/lib/router/layer.js:91:12)
            at trim_prefix (/fswas/wasadm/nodeStudy/node_modules/express/lib/router/index.js:328:13)

        ```



## 에러처리 미들웨어 만들기
```bash
.
├── app.js
├── server.js
├── controllers
│   ├── main
│   │   └── main.controller.js
│   └── member
│        └── member.controller.js
├── middlewares    # 미들웨어를 관리 전용 디렉토리를 생성
└── routes
     ├── index.js         
     ├── main
     │    └── index.js   
     └── member
           ├── basic
           │   └── index.js
           └── index.js
```

### STEP1. 미들웨어 관리 디렉토리 생성
```bash
mkdir middlewares
touch middlewares/logger.js

```

### STEP2 로그 찍는 미들웨어 모듈 만들기
***/middlewares/logger.js***
```js
/* AS-IS: 단순로그
const logger = function() {
    return function(req, res, next) {
        console.log('미들웨어 발동');
        next();
    }
}
*/
// TO-BE: 요청메소드, URL 출력
const logger = () => (req, res, next) => {
  const log = `\n${req.method} ${req.url}`;
  console.log(log);
  next();
}

module.exports = logger();

```

***주의)***  
미들웨어 등록시 `app.use(미들웨어)` 를 사용했다.  
미들웨어 부분은 function(req, res, next) 이므로 꼭 <span style='color:red'>함수를 리턴하도록 구현</span>해야한다.

### STEP2 로그 찍는 미들웨어 모듈 만들기
***/app.js***  
```js
const express = require('express');
const PORT = 3000;
const logger = require('./middlewares/logger');

class App {
    constructor() {
	    this.app = express();
	    this.setMiddlewares();  //미들웨어 생성자 SET
	    this.setRouting();
    }
    
    setRouting() {
        const routes = require('./routes'); 
        this.app.use('/', routes);
    }
    
    setMiddlewares() {
        this.app.use(logger);  //만든 'logger' 미들웨어 등록
    }
}

module.exports = new App().app;

```

## 결과
```bash
# 클라이언트 접속 (http://호스트:포트/member/select)
GET /member/select

# 클라이언트 접속 (http://호스트:포트/)
GET /

```