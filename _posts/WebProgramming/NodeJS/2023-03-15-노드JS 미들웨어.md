---
title:  "노드JS 미들웨어"
excerpt: "노드JS 미들웨어 입니다."

categories:
  - nodejs
tags:
  - [node.js]

toc: true
toc_sticky: true

last_modified_at: 2023-03-15T20:00:00-05:00
---

## 미들웨어

> ***미들웨어는 Express 모듈의 핵심이다.***

Node.js에서 미들웨어는 클라이언트의 요청과 서버의 응답 사이에서 동작하는 함수이다.  

```js
app.use(미들웨어);

```

<span style='color:red'>`app.use` 안에 있는 모든 함수들은 모두 미들웨어</span>이며 <span style='color:red'>요청이 올때마다 이 미들웨어를 거친다</span>. 즉, 요청과 응답의 중간(middle, 미들)에 위치하여 미들웨어 라고 부른다.
미들웨어는 요청과 응답을 조작하여 기능을 추가하기도 하고, 나쁜 요청을 걸러내기도 한다.


### 미들웨어 처리 과정
1. 미들웨어는 요청과 응답을 조작하고, 
2. 다음 미들웨어를 호출하고, 
3. 요청을 처리하는 핵심 애플리케이션 로직에 접근할 수 있다. (next)


### 미들웨어 구조와 동작
미들웨어는 req, res, next와 같은 매개변수를 받아서 작동한다.  

***구조***
- req: HTTP 요청 객체. 
- res: HTTP 응답 객체입니다
- next: 다음 미들웨어를 호출하는 함수. 미들웨어는 next 함수를 호출하지 않으면 다음 미들웨어를 실행하지 않는다.
  

***동작***
1. app.use 메소드를 사용하여 원하는 미들웨어를 등록하고
2. app.get 메소드를 사용하여 라우터 미들웨어를 등록한다. 
3. 끝

> ***"라우터도 미들웨어다."***

```js
const express = require('express');
const cors = require('cors'); // cors 미들웨어 임포트

const app = express();

// CASE1: 모듈 미들웨어 (이미 구현된 cors 라는 모듈의 미들웨어)
app.use(cors()); 

// CASE2: 사용자정의 미들웨어
app.use((req, res, next) => {   // 로그를 찍는 용도의 미들웨어
  console.log('first');
  next();
});

// CASE3: 모듈 미들웨어 (라우트 핸들러 미들웨어)
app.get('/', (req, res) => {
  res.send('Hello, World!');
});

```

위 코드에서는 총 3개의 미들웨어를 구현하고있다.
- cros 미들웨어
- 로그를 찍는 미들웨어
- 라우터핸들러 미들웨어

이제 라우터 요청을 수행하기 전에 등록한 미들웨어가 동작하게 된다. 마치 스프링의 AOP 미들웨어를 구현한 느낌이다..!



## 미들웨어 구현 예제
```bash
# 미들웨어 관리 폴더를 생성하고 작업한다.
mkdir middlewares
cd middlewares

```
### 로그 찍는 미들웨어 모듈 만들기
***/middlewares/logger.js***
```js
const logger = () => (req, res, next) => {
  const log = `${req.method} ${req.url}`
  console.log(log)
  next()
}

module.exports = logger

```

***/app.js***  
```js
const express = require('express');
const app = express();

// 미들웨어 Import
const logger = require('./middlewares/logger'); 

// 미들웨어 등록
app.use(logger())

// 서버 실행
app.listen(3000, () => {
  console.log('Server is running on port 3000');
});

```

```bash
# 접속 /about
GET /about
# 접속 /product
GET /product
# 접속 /admin
GET /admin

```


### Express의 에러처리 미들웨어
에러 핸들링을 위한 미들웨어어 알아본다. Express에서 제공하는 next 함수의 인자로 에러 객체를 전달하면, 에러 핸들러 미들웨어에서 처리할 수 있다.

***/app.js***  
```js
const express = require('express');
const app = express();

// (라우트 핸들러 미들웨어)
app.get('/', (req, res) => {
  res.send('Hello, World!');
});

// (에러처리 미들웨어) 
// 1. 맨앞 err을 포함한 인자 4개를 가지는 특징이 있다.
// 2. 라우터 미들웨어보다 뒤에있는 특징이 있다.
app.use((err, req, res, next) => {
  console.error(err);                       // 에러 로그를 출력
  res.status(500).send('Something broke!'); // 에러 응답을 전송
});

// 서버 실행
app.listen(3000, () => {
  console.log('Server is running on port 3000');
});

```
Express에서 에러 처리 미들웨어는 4개의 인자로 `오버로딩` 되어 구현되어있다.  
이 미들웨어의 특이한 점은 next() 함수를 호출하지 않아도 된다. 이는 다른 미들웨어와 달리, 요청 처리 결과에 영향을 미치지 않는 특수한 미들웨어이기 때문이다.  

1. app.use를 사용하여 등록 한다.
    - 첫 번째 인자를 err(에러) 객체로 하여 총 4개의 인자를 부여 해야한다.

2. 특수한 미들웨어라서 일반적으로, 모든 미들웨어 다음줄 `code line` 에 등록하며, 요청 처리 중 발생하는 에러를 처리한다. 아래는 호출되는 예시다.
    - next(err) 함수를 호출한 경우
    - 라우터 함수나 미들웨어 함수 내부에서 에러가 발생한 경우

3. 에러가 발생한 경우 이후의 미들웨어는 실행되지 않고, 바로 에러 처리 미들웨어로 전달 된다.


### 라우터 미들웨어
```js
const express = require('express');
const app = express();
const router = express.Router();

// 라우터 미들웨어 등록
//이 미들웨어는 router.get() 함수로 등록된 라우트 핸들러가 실행되기 전에 항상 실행
router.use((req, res, next) => {
  console.log('Router middleware executed.');
  next();
});

/* 라우트 핸들러 등록
* WAS 설정에서 docBase 설정과 동일해보인다.
*/
router.get('/co', (req, res) => {
  res.send('Hello, router!');
});

/* 라우터 등록 
* WAS 설정에서 ContextPath 설정과 동일해보인다. (만약 /router 경로 요청이 오면)
*/
app.use('/router', router);

// 기본 라우트 핸들러 등록
app.get('/', (req, res) => {
  res.send('Hello, world!');
});

app.listen(3000, () => {
  console.log('Server is listening on port 3000');
});

```
